name: Build README and deploy Datasette

on:
  push:
    branches:
    - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Check out repo
      uses: actions/checkout@v4
      # We need full history to introspect created/updated:
      with:
        fetch-depth: 0
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    - uses: actions/cache@v4
      name: Configure pip caching
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Build database
      env:
        MARKDOWN_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: python build_database.py
    - name: Update README
      run: |-
        python update_readme.py --rewrite
        cat README.md
    - name: Commit and push if README changed
      run: |-
        git diff
        git config --global user.email "actions@users.noreply.github.com"
        git config --global user.name "README-bot"
        git diff --quiet || (git add README.md && git commit -m "Updated README")
        git pull --rebase
        git push
    - name: Install Fly
      run: curl -L https://fly.io/install.sh | sh
    - name: Deploy Datasette using Fly
      env:
        FLY_API_TOKEN: ${{ secrets.FLY_TOKEN }}
      run: |-
        export PATH=$PATH:/home/runner/.fly/bin/

        # Generate the Datasette publish directory without deploying
        datasette publish fly tils.db \
          --app ${{ vars.FLY_APP_NAME }} \
          --metadata metadata.yaml \
          --static static:static \
          --install datasette-template-sql \
          --install "datasette-sitemap>=1.0" \
          --install "datasette-atom>=0.7" \
          --install datasette-json-html \
          --install beautifulsoup4 \
          --install "datasette-graphql>=2.2" \
          --install datasette-block-robots \
          --plugins-dir plugins \
          --template-dir templates \
          --setting allow_facet off \
          --generate-dir /tmp/datasette-publish

        # Set primary region to Paris
        sed -i 's/^primary_region = .*/primary_region = "cdg"/' /tmp/datasette-publish/fly.toml

        # Deploy from the generated directory
        cd /tmp/datasette-publish
        fly deploy
