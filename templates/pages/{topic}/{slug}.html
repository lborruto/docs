{% extends "til_base.html" %}

{% set tils = sql("""
    select * from til where path = :topic || '_' || :slug || '.md'
""", {"topic": topic, "slug": slug}, database="tils")
%}
{% set til = tils[0] %}
{% if not tils %}
    {% set raised = raise_404("TIL not found") %}
{% endif %}

{% block title %}{{ til.title }} | TIL{% endblock %}

{% block extra_head %}
<script>
// Fix broken images if data-canonical-src is available
function handleImageError(event) {
  if (event.target.tagName === 'IMG') {
    const canonicalSrc = event.target.getAttribute('data-canonical-src');
    if (canonicalSrc) {
      event.target.src = canonicalSrc;
    }
  }
}
document.addEventListener('DOMContentLoaded', () => {
  document.body.addEventListener('error', handleImageError, true);
});
</script>
{% endblock %}

{% block body %}
<h1>{{ til.title }}</h1>

{{ til.html|safe }}

<p class="created">Created {{ til.created }}{% if til.created != til.updated %}, updated {{ til.updated }} &middot; <a href="{{ til.url|replace("/blob/", "/commits/") }}">History</a>{% endif %} &middot; <a href="{{ til.url }}">Edit</a></p>

<script>
// Add visible # links to all h2+ headings
document.querySelectorAll('h2,h3,h4,h5,h6').forEach(el => {
  let id = el.id || null;

  // Case 1: link nested inside the heading (".heading-link")
  const inner = el.querySelector('.heading-link');
  if (inner) {
    id = id || (inner.getAttribute('href') || '').replace(/^#/, '') || el.id;
    el.textContent = inner.textContent; // keep just the text
    inner.remove();
  }

  // Case 2: GitHub-style sibling <a class="anchor"> next to the heading
  if (!id) {
    const sib = el.nextElementSibling;
    if (sib && sib.matches('a.anchor')) {
      const href = sib.getAttribute('href') || '';
      const hrefId = href.startsWith('#') ? href.slice(1) : null;
      id = hrefId || sib.id || null;
      sib.remove();
    }
  }

  if (!id) return;

  el.id = id;

  const hashLink = document.createElement('a');
  hashLink.href = '#' + id;
  hashLink.textContent = '#';
  hashLink.style.textDecoration = 'none';
  hashLink.style.color = '#b7b3b3';
  hashLink.style.fontSize = '0.8em';

  el.appendChild(document.createTextNode(' '));
  el.appendChild(hashLink);
});

// Add an audio player after any .wav or .mp3 links
document.querySelectorAll('a[href$=".wav"],a[href$=".mp3"],a[href$=".m4a"]').forEach(function(link) {
  var href = link.getAttribute('href');
  var audio = document.createElement('audio');
  audio.controls = true;
  audio.src = href;
  var paragraph = document.createElement('p');
  paragraph.appendChild(audio);
  link.insertAdjacentElement('afterend', paragraph);
});
</script>
{% endblock %}
